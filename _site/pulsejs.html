<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Going mobile with Cordova</title>
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Gentium+Book+Basic:400,400italic,700,700italic">
    <link rel="stylesheet" type="text/css" href="/stylesheets/highlightjs.css">
    <link rel="stylesheet" type="text/css" href="/stylesheets/monokai_sublime.css">
    <link rel="stylesheet" type="text/css" href="/stylesheets/style.css">
    <!--script src="//use.typekit.net/moh3ocg.js"></script>
    <script>try{Typekit.load();}catch(e){}</script-->
  </head>
  <body>
    <header class="header">
      <a class="home" href="/">
        <h1 class="logo">
          <img src="/images/logo.png" alt="Tech@Streethub logo">
        </h1>
        <h2 class="description">
          JS: front/back, desktop/mobile
        </h2>
      </a>
    </header>
    <article class="single">
  <div class="cover" style="background-image: url(/images/covers/cordova.png);"></div>
  <!-- <time class="date" datetime="">23 May 2014</time> -->
  <div class="heading">
    <h1 class="title">
      Going mobile with Cordova
    </h1>
    <h2 class="subtitle">
      Web and Native
    </h2>
    <ul class="info">
      <li>#mobile</li>
      <li>@Arnaud</li>
      <li>☼ 23 May 2014</li>
    </ul>
  </div>
  <div class="content">
    <p>A few months ago, we decided to develop the new Streethub iPhone app with Cordova.</p>

<blockquote>
<p>Apache Cordova is a platform for building native mobile applications
using HTML, CSS and JavaScript.</p>
</blockquote>

<p>Cordova allows you to build iOS apps like you would build a web app. On top of using common web technologies (HTML, CSS, JS), you have access to native iOS functionalities (GPS, Accelerometer…).</p>

<h2>Plugins magic</h2>

<p>Although you can do most of the work with web technologies, we quickly found out that some parts of our mobile app needed to use iOS plugins. Indeed, implementing a non-native map was sluggish at best on an iPhone 4.</p>

<p>Installing iOS plugins for Cordova is straightforward, you can find all the plugins on the <a href="http://plugins.cordova.io/.">cordova website</a> If you feel adventurous, you can <a href="http://cordova.apache.org/docs/en/3.4.0/guide_hybrid_plugins_index.md.html#Plugin%20Development%20Guide">build your own plugins</a>.</p>

<p>These plugins are wrappers around common iOS libraries. They fill the role of a communication layer between the iOS plugin and your web app contained in a web view. Cordova renders your app in a web view and has access to the <code>window</code> object, where most of the plugins inject their libraries.</p>

<h2>Extending plugins</h2>

<p>In our app, we have used the <a href="https://github.com/imhotep/MapKit">MapKit cordova plugin</a> plugin. Most of core features were already implemented but we need to use more methods from the mapkit framework (map scrolling). You can easily extend a plugin by adding the declaration of the method in the header file and the declaration in the .m file.  Then, you can execute the newly added method with the following code.</p>

<p>On the iOS side (Objective-C)</p>
<div class="highlight"><pre><code class="language-objective-c" data-lang="objective-c"><span class="c1">// Header file (.h)</span>
<span class="k">@interface</span> <span class="nc">MapKitView</span> : <span class="nc">CDVPlugin</span> <span class="o">&lt;</span><span class="bp">MKMapViewDelegate</span><span class="o">&gt;</span>
<span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nl">changePinsColor</span><span class="p">:(</span><span class="n">CDVInvokedUrlCommand</span> <span class="o">*</span><span class="p">)</span><span class="n">command</span><span class="p">;</span>
<span class="k">@end</span>

<span class="c1">// Declaration (.m)</span>

<span class="c1">// Header files</span>
<span class="c1">// ...</span>

<span class="k">@implementation</span> <span class="nc">MapKitView</span>
<span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">changePinsColor:</span><span class="p">(</span><span class="n">CDVInvokedUrlCommand</span> <span class="o">*</span><span class="p">)</span><span class="nv">command</span>
<span class="p">{</span>
    <span class="n">CDVPluginResult</span><span class="o">*</span> <span class="n">pluginResult</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>

    <span class="c1">// ...</span>

    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="p">){</span>
        <span class="n">pluginResult</span> <span class="o">=</span> <span class="p">[</span><span class="n">CDVPluginResult</span> <span class="nl">resultWithStatus</span><span class="p">:</span><span class="n">CDVCommandStatus_OK</span><span class="p">];</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">pluginResult</span> <span class="o">=</span> <span class="p">[</span><span class="n">CDVPluginResult</span> <span class="nl">resultWithStatus</span><span class="p">:</span><span class="n">CDVCommandStatus_ERROR</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="c1">// Callback function for plugin</span>
    <span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="n">commandDelegate</span>
        <span class="nl">sendPluginResult</span><span class="p">:</span><span class="n">pluginResult</span>
        <span class="nl">callbackId</span><span class="p">:</span><span class="n">command</span><span class="p">.</span><span class="n">callbackId</span><span class="p">];</span>
<span class="p">}</span>
<span class="k">@end</span>
</code></pre></div>
<p>On the web app side (Javascript)</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="c1">// Generic example</span>
<span class="nx">cordovaRef</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">success</span><span class="p">,</span> <span class="nx">error</span><span class="p">,</span> <span class="s2">&quot;service&quot;</span><span class="p">,</span> <span class="s2">&quot;action&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nx">params</span><span class="p">]);</span>

<span class="c1">// Mapkit example</span>
<span class="nx">cordovaRef</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">){</span>
    <span class="c1">// Success handling</span>
<span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span>
    <span class="c1">// Error handling</span>
<span class="p">},</span>
<span class="s2">&quot;MapKit&quot;</span><span class="p">,</span> <span class="s2">&quot;changePinsColor&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;red&#39;</span><span class="p">]);</span>
</code></pre></div>
<h2>Executing javascript</h2>

<p>Now, Imagine you need to communicate from the iOS method to your webapp, you can use the <code>stringByEvaluatingJavaScriptFromString</code> method.</p>
<div class="highlight"><pre><code class="language-objective-c" data-lang="objective-c"><span class="c1">// Execute a javascript function in the web view</span>
<span class="bp">NSString</span> <span class="o">*</span><span class="n">FunctionString</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSString</span> <span class="nl">stringWithFormat</span><span class="p">:</span><span class="s">@&quot;%s&quot;</span><span class="p">,</span> <span class="s">&quot;someCallback()&quot;</span><span class="p">];</span>
<span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="n">webView</span> <span class="nl">stringByEvaluatingJavaScriptFromString</span><span class="p">:</span><span class="n">FunctionString</span><span class="p">];</span>
</code></pre></div>
<p>You only need to defined the <code>someCallback</code> in your webapp and attach it to the <code>window</code> object.</p>

<h2>Wrapping up</h2>

<p>We have seen that you can Cordova is a powerful tool to get native functionalities into your app. While most of the plugins available online are useful and up-date, they often lack flexibility and rarely cover all the method of the targeted framework.</p>

<p>That&#39;s why we decided to build <code>pulse.js</code>. This javascript micro-library makes extending your plugins on cordova/phonegap easy. Most of the plugins inject their methods in the window object and that&#39;s exactly what <code>pulse.js</code> does. Here&#39;re two examples of what <code>pulse.js</code> can do for you.</p>

<ul>
<li><code>Pulse.beat</code> communicates with the iOS app. It&#39;ll use the <code>cordova.exec</code> method to execute any method in an cordova plugin.</li>
</ul>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="c1">// Calls the changePinsColor method in the mapKit cordova plugin</span>
<span class="nx">Pulse</span><span class="p">.</span><span class="nx">beat</span><span class="p">(</span><span class="s1">&#39;mapKit.changePinsColor&#39;</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="nx">success</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span>
</code></pre></div>
<ul>
<li><code>Pulse.listen</code> registers a method specific to a plugin. You can use it as a callback in your iOS code.</li>
</ul>

<p>We currently use it as a callback for the regionDidChangeAnimated event. It will return us the visible pins on the map.</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="c1">// Register event to show the visible annotations on the map</span>
<span class="nx">Pulse</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="s1">&#39;mapKit.regionDidChangeAnimated&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">){</span>
 <span class="c1">// Success</span>
<span class="p">});</span>
</code></pre></div><div class="highlight"><pre><code class="language-objective-c" data-lang="objective-c"><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">mapView:</span><span class="p">(</span><span class="bp">MKMapView</span> <span class="o">*</span><span class="p">)</span><span class="nv">mapView</span> <span class="nf">regionDidChangeAnimated:</span><span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nv">animated</span> <span class="p">{</span>
    <span class="c1">// ...</span>

    <span class="bp">NSString</span> <span class="o">*</span><span class="n">functionString</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSString</span>
        <span class="nl">stringWithFormat</span><span class="p">:</span><span class="s">@&quot;%s&quot;</span><span class="p">,</span> <span class="s">&quot;mapKit.regionDidChangeAnimated()&quot;</span><span class="p">];</span>
    <span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="n">webView</span> <span class="nl">stringByEvaluatingJavaScriptFromString</span><span class="p">:</span><span class="n">functionString</span><span class="p">];</span>

<span class="p">}</span>
</code></pre></div>
<p>This small communication layer makes it easy to transmit informations between the webview and any iOS plugin.</p>

<p>You can check it out on <a href="https://github.com/StreetHub/pulse.js">GitHub</a> and download it via bower.</p>

<p><code>bower install pulse.js</code></p>

<h2>Conclusion</h2>

<p>Using Cordova speeds up the development process a lot. Most of the basic features of a mobile are easily doable in Javascript. There&#39;re many guides to optimize animations which we haven&#39;t covered. When you need to use an iOS frameworks like MapKit, you might need to learn some Objective-C and add some functionalities. Using <code>pulse.js</code> simplifies this process and allows you to focus on writing useful code</p>

<p>If you have questions, ping tech@streethub.com.</p>

  </div>
</article>

    <a class="link streethub" href="https://www.streethub.com">
      Visit streethub.com
      <span>▶</span>
    </a>
    <script type="text/javascript" src="/javascript/highlight.min.js"></script>
    <script type="text/javascript" src="/javascript/scripts.js"></script>
  </body>
</html>